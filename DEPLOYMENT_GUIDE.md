# Vercel éƒ¨ç½²è¸©å‘æŒ‡å— - æ–‡ä»¶æœåŠ¡å™¨é¡¹ç›®

## é¡¹ç›®ç®€ä»‹

è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å›½é™…åŒ–æ–‡ä»¶æµè§ˆå’Œä¸‹è½½æœåŠ¡å™¨ï¼Œæ”¯æŒä¸­è‹±æ—¥ä¸‰è¯­è¨€ï¼Œä½¿ç”¨ Vite + Vanilla JS æ„å»ºï¼Œéƒ¨ç½²åœ¨ Vercel ä¸Šã€‚

## æ ¸å¿ƒåŠŸèƒ½

- ğŸ“ æ–‡ä»¶å¤¹å’Œæ–‡ä»¶æµè§ˆ
- ğŸŒ ä¸‰è¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡/æ—¥æ–‡ï¼‰
- ğŸ“¥ æ–‡ä»¶ä¸‹è½½å’Œé“¾æ¥å¤åˆ¶
- ğŸ” SHA-256 å“ˆå¸Œå€¼è®¡ç®—
- ğŸ“± å“åº”å¼è®¾è®¡

## è¸©å‘è®°å½•

### å‘ 1ï¼šVercel API è·¯ç”±é…ç½®æ··ä¹±

**é—®é¢˜ï¼š** æœ€åˆä½¿ç”¨å•ä¸ª `api/index.js` æ–‡ä»¶å¤„ç†æ‰€æœ‰è·¯ç”±ï¼Œå¯¼è‡´ 404 é”™è¯¯ã€‚

**åŸå› ï¼š** Vercel çš„ Serverless Functions é‡‡ç”¨æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼Œæ¯ä¸ªæ–‡ä»¶è‡ªåŠ¨æ˜ å°„ä¸ºä¸€ä¸ªç«¯ç‚¹ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
```
api/
â”œâ”€â”€ browse.js    â†’ /api/browse
â””â”€â”€ download.js  â†’ /api/download
```

**æ•™è®­ï¼š** ä¸è¦è¯•å›¾åœ¨ Vercel ä¸Šä½¿ç”¨ Express é£æ ¼çš„è·¯ç”±ï¼Œéµå¾ªå¹³å°çº¦å®šã€‚

---

### å‘ 2ï¼šæ–‡ä»¶å­˜å‚¨è·¯å¾„é—®é¢˜

**é—®é¢˜ï¼š** å°è¯•ä½¿ç”¨ `/tmp` ä¸´æ—¶ç›®å½•å­˜å‚¨æ–‡ä»¶ï¼Œä½†æ¯æ¬¡å†·å¯åŠ¨éƒ½ä¼šæ¸…ç©ºã€‚

**é”™è¯¯å°è¯•ï¼š**
```javascript
const STORAGE_DIR = process.env.VERCEL ? '/tmp/files' : join(process.cwd(), 'public', 'files');
```

**åŸå› ï¼š** Vercel Serverless Functions çš„ `/tmp` ç›®å½•æ˜¯ä¸´æ—¶çš„ï¼Œä¸é€‚åˆæŒä¹…åŒ–å­˜å‚¨ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** å°†æ–‡ä»¶å­˜å‚¨åœ¨é¡¹ç›®çš„ `public/files` ç›®å½•ä¸­ï¼Œå¹¶é…ç½® `includeFiles`ï¼š

```json
{
  "functions": {
    "api/*.js": {
      "includeFiles": "public/files/**"
    }
  }
}
```

**æ•™è®­ï¼š** Serverless ç¯å¢ƒä¸‹ï¼Œæ–‡ä»¶è¦ä¹ˆå­˜å‚¨åœ¨ä»£ç ä»“åº“ä¸­ï¼Œè¦ä¹ˆä½¿ç”¨å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆå¦‚ Vercel Blobï¼‰ã€‚

---

### å‘ 3ï¼šä¾èµ–ç®¡ç†å†²çª

**é—®é¢˜ï¼š** ä½¿ç”¨ pnpm æœ¬åœ°å¼€å‘ï¼Œä½† Vercel æ„å»ºæ—¶å‡ºç°ä¾èµ–å†²çªï¼š
```
npm error ERESOLVE could not resolve
npm error While resolving: debug@2.6.9
```

**åŸå› ï¼š** `pnpm-lock.yaml` ä¸­åŒ…å«äº†æ—§çš„æˆ–ä¸å…¼å®¹çš„ä¾èµ–è®°å½•ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
1. åˆ é™¤ `pnpm-lock.yaml`
2. åœ¨ `vercel.json` ä¸­æŒ‡å®šå®‰è£…å‘½ä»¤ï¼š
```json
{
  "installCommand": "npm install --legacy-peer-deps"
}
```

**æ•™è®­ï¼š** 
- æœ¬åœ°å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒæœ€å¥½ä½¿ç”¨ç›¸åŒçš„åŒ…ç®¡ç†å™¨
- å¦‚æœå¿…é¡»åˆ‡æ¢ï¼Œåˆ é™¤ lock æ–‡ä»¶å¹¶ä½¿ç”¨ `--legacy-peer-deps` æ ‡å¿—

---

### å‘ 4ï¼šå‰ç«¯é”™è¯¯å¤„ç†ä¸å®Œå–„

**é—®é¢˜ï¼š** API è¿”å›é”™è¯¯æ—¶ï¼Œå‰ç«¯å°è¯•è®¿é—® `data.items.length` å¯¼è‡´ `Cannot read properties of undefined`ã€‚

**é”™è¯¯ä»£ç ï¼š**
```javascript
const data = await res.json();
renderFiles(data.items); // data.items å¯èƒ½æ˜¯ undefined
```

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
const data = await res.json();

if (!res.ok || data.error) {
  console.error('API error:', data);
  showError(data.error || 'Failed to load directory');
  return;
}

renderFiles(data.items || []);
```

**æ•™è®­ï¼š** æ°¸è¿œä¸è¦å‡è®¾ API è¿”å›çš„æ•°æ®ç»“æ„ï¼Œå§‹ç»ˆæ£€æŸ¥å“åº”çŠ¶æ€å’Œæ•°æ®å®Œæ•´æ€§ã€‚

---

### å‘ 5ï¼šVercel å·¥ä½œç›®å½•ç†è§£é”™è¯¯

**é—®é¢˜ï¼š** ä¸æ¸…æ¥š Vercel Serverless Function çš„å®é™…å·¥ä½œç›®å½•ã€‚

**è°ƒè¯•æ–¹æ³•ï¼š** æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼š
```javascript
res.status(500).json({ 
  error: 'Storage directory not found',
  cwd: process.cwd(),  // è¾“å‡ºå½“å‰å·¥ä½œç›®å½•
  tried: possiblePaths  // è¾“å‡ºå°è¯•çš„æ‰€æœ‰è·¯å¾„
});
```

**å‘ç°ï¼š** Vercel çš„å·¥ä½œç›®å½•æ˜¯ `/var/task`ï¼Œè€Œä¸æ˜¯é¡¹ç›®æ ¹ç›®å½•ã€‚

**æ•™è®­ï¼š** åœ¨ Serverless ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ `process.cwd()` å’Œè¯¦ç»†æ—¥å¿—æ¥è°ƒè¯•è·¯å¾„é—®é¢˜ã€‚

---

### å‘ 6ï¼šGit æ¨é€å†²çª

**é—®é¢˜ï¼š** æœ¬åœ°æäº¤åæ¨é€å¤±è´¥ï¼š
```
error: failed to push some refs to 'https://github.com/...'
hint: Updates were rejected because the remote contains work that you do not have locally
```

**åŸå› ï¼š** åœ¨ GitHub ç½‘é¡µä¸Šç›´æ¥ç¼–è¾‘äº†æ–‡ä»¶ï¼ˆå¦‚ READMEï¼‰ï¼Œå¯¼è‡´è¿œç¨‹æœ‰æœ¬åœ°æ²¡æœ‰çš„æäº¤ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
git pull --rebase  # ä½¿ç”¨ rebase ä¿æŒå†å²æ•´æ´
git push
```

**æ•™è®­ï¼š** 
- ä¼˜å…ˆä½¿ç”¨ `git pull --rebase` è€Œä¸æ˜¯ `git pull`ï¼ˆmergeï¼‰
- é¿å…åœ¨å¤šä¸ªåœ°æ–¹åŒæ—¶ç¼–è¾‘ä»£ç 

---

## æœ€ä½³å®è·µæ€»ç»“

### 1. Vercel é…ç½®
```json
{
  "functions": {
    "api/*.js": {
      "memory": 1024,
      "maxDuration": 10,
      "includeFiles": "public/files/**"
    }
  },
  "outputDirectory": "dist",
  "buildCommand": "npm run build",
  "installCommand": "npm install --legacy-peer-deps",
  "framework": "vite"
}
```

### 2. API è·¯ç”±ç»“æ„
- æ¯ä¸ªç«¯ç‚¹ä¸€ä¸ªæ–‡ä»¶
- ä½¿ç”¨ `export default async function handler(req, res)`
- æ·»åŠ  CORS å¤´æ”¯æŒè·¨åŸŸ

### 3. æ–‡ä»¶å­˜å‚¨
- å°æ–‡ä»¶ï¼šå­˜å‚¨åœ¨ `public/files` ç›®å½•
- å¤§æ–‡ä»¶ï¼šä½¿ç”¨ Vercel Blob æˆ–å…¶ä»–å¯¹è±¡å­˜å‚¨
- é…ç½® `includeFiles` ç¡®ä¿æ–‡ä»¶è¢«æ‰“åŒ…

### 4. é”™è¯¯å¤„ç†
- API ç«¯ï¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ•°æ®
- å‰ç«¯ï¼šæ£€æŸ¥å“åº”çŠ¶æ€å’Œæ•°æ®å®Œæ•´æ€§
- ä½¿ç”¨ `console.error` è®°å½•é”™è¯¯æ—¥å¿—

### 5. ä¾èµ–ç®¡ç†
- ä¿æŒ `package.json` ç®€æ´
- åˆ é™¤ä¸å¿…è¦çš„ä¾èµ–
- ä½¿ç”¨ `--legacy-peer-deps` è§£å†³å…¼å®¹æ€§é—®é¢˜

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é›¶å¤–éƒ¨ä¾èµ–
- ä½¿ç”¨å†…è” SVG å›¾æ ‡ï¼Œä¸å¼•å…¥å›¾æ ‡åº“
- åŸç”Ÿ JavaScriptï¼Œæ— æ¡†æ¶å¼€é”€
- Web Crypto API è®¡ç®— SHA-256

### 2. å¿«é€ŸåŠ è½½
- Vite æ„å»ºä¼˜åŒ–
- æœ€å°åŒ– CSS å’Œ JS
- é™æ€èµ„æº CDN åŠ é€Ÿ

### 3. ç”¨æˆ·ä½“éªŒ
- Toast æç¤ºä»£æ›¿ alert å¼¹çª—
- æ¨¡æ€æ¡†å±•ç¤ºæ–‡ä»¶è¯¦æƒ…
- å“åº”å¼è®¾è®¡é€‚é…ç§»åŠ¨ç«¯

---

## éƒ¨ç½²æµç¨‹

1. **æœ¬åœ°å¼€å‘**
```bash
npm install
npm run dev
```

2. **æ·»åŠ æ–‡ä»¶**
```bash
# å°†æ–‡ä»¶æ”¾å…¥ public/files ç›®å½•
git add public/files/
git commit -m "Add files"
git push
```

3. **Vercel è‡ªåŠ¨éƒ¨ç½²**
- æ¨é€åˆ° GitHub åè‡ªåŠ¨è§¦å‘
- æ„å»ºæ—¶é—´çº¦ 1-2 åˆ†é’Ÿ
- æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—æ’æŸ¥é—®é¢˜

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ•°æ®åº“ï¼Ÿ
A: è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§æ–‡ä»¶æœåŠ¡å™¨ï¼Œæ–‡ä»¶ç›´æ¥å­˜å‚¨åœ¨ä»£ç ä»“åº“ä¸­ï¼Œé€‚åˆå°æ–‡ä»¶å’Œé™æ€èµ„æºã€‚

### Q: å¦‚ä½•ä¸Šä¼ æ–‡ä»¶ï¼Ÿ
A: é€šè¿‡ Git æäº¤åˆ° `public/files` ç›®å½•ï¼Œä¸æ”¯æŒåœ¨çº¿ä¸Šä¼ ï¼ˆé¿å…æ»¥ç”¨ï¼‰ã€‚

### Q: æ–‡ä»¶å¤§å°é™åˆ¶ï¼Ÿ
A: Vercel Serverless Function å“åº”å¤§å°é™åˆ¶ä¸º 4.5MBï¼Œå»ºè®®åªå­˜å‚¨å°æ–‡ä»¶ã€‚

### Q: å¦‚ä½•æ·»åŠ è®¤è¯ï¼Ÿ
A: å¯ä»¥åœ¨ API è·¯ç”±ä¸­æ·»åŠ  token éªŒè¯ï¼Œæˆ–ä½¿ç”¨ Vercel çš„ Edge Middlewareã€‚

---

## æŠ€æœ¯æ ˆ

- **å‰ç«¯ï¼š** Vite + Vanilla JS
- **åç«¯ï¼š** Vercel Serverless Functions (Node.js)
- **éƒ¨ç½²ï¼š** Vercel + GitHub
- **æ ·å¼ï¼š** åŸç”Ÿ CSSï¼ˆæ— æ¡†æ¶ï¼‰
- **å›¾æ ‡ï¼š** å†…è” SVG

---

## æ€»ç»“

éƒ¨ç½²åˆ° Vercel çš„å…³é”®æ˜¯ç†è§£ Serverless ç¯å¢ƒçš„é™åˆ¶å’Œçº¦å®šï¼š

1. âœ… éµå¾ªæ–‡ä»¶ç³»ç»Ÿè·¯ç”±
2. âœ… ä½¿ç”¨ `includeFiles` åŒ…å«é™æ€èµ„æº
3. âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
4. âœ… ç®€æ´çš„ä¾èµ–ç®¡ç†
5. âœ… ç†è§£ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿçš„é™åˆ¶

å¸Œæœ›è¿™ä»½æŒ‡å—èƒ½å¸®åŠ©ä½ é¿å…åŒæ ·çš„å‘ï¼

---

**é¡¹ç›®åœ°å€ï¼š** https://github.com/xhc861/LightFileServer
**åœ¨çº¿æ¼”ç¤ºï¼š** https://lfile.xhc861.top
